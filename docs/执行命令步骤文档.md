# TotalSpineSeg 执行命令步骤文档

本文档提供TotalSpineSeg的完整使用指南，从环境验证到实际推理的详细步骤。

## 目录

1. [环境验证](#环境验证)
2. [模型初始化](#模型初始化)
3. [数据集下载（用于训练）](#数据集下载用于训练)
4. [基本推理使用](#基本推理使用)
5. [高级选项](#高级选项)
6. [使用定位器辅助](#使用定位器辅助)
7. [输出结果说明](#输出结果说明)
8. [常见使用场景](#常见使用场景)
9. [故障排除](#故障排除)

---

## 环境验证

### 1. 激活conda环境

```bash
# 激活之前创建的conda环境
conda activate tss
```

### 2. 验证安装

```bash
# 检查TotalSpineSeg是否安装成功
totalspineseg --help

# 检查PyTorch和CUDA
python -c "import torch; print(f'PyTorch版本: {torch.__version__}'); print(f'CUDA可用: {torch.cuda.is_available()}'); print(f'CUDA版本: {torch.version.cuda if torch.cuda.is_available() else \"N/A\"}')"

# 检查GPU
nvidia-smi
```

### 3. 设置数据目录（可选）

```bash
# 创建数据目录（用于存储模型权重）
mkdir -p /root/TotalSpineSeg/data

# 设置环境变量（临时，当前终端有效）
export TOTALSPINESEG_DATA="/root/TotalSpineSeg/data"

# 或者永久设置（添加到~/.bashrc或~/.zshrc）
echo 'export TOTALSPINESEG_DATA="/root/TotalSpineSeg/data"' >> ~/.bashrc
source ~/.bashrc
```

**注意**: 如果不设置`TOTALSPINESEG_DATA`，模型权重将存储在包目录下（`totalspineseg/models`）。

---

## 模型初始化

### 首次使用：下载预训练模型

TotalSpineSeg在首次运行时会自动下载预训练模型，但你也可以手动初始化：

```bash
# 手动初始化模型（下载预训练权重）
totalspineseg_init

# 静默模式（不显示进度条）
totalspineseg_init --quiet

# 指定数据目录
totalspineseg_init --data-dir /root/TotalSpineSeg/data

# 不保存导出的zip文件（节省空间）
totalspineseg_init --store-export
```

**说明**:
- 首次运行`totalspineseg`命令时，如果模型未安装，会自动下载
- 模型下载可能需要一些时间（约几GB大小）
- 下载完成后，后续使用无需重新下载

---

## 数据集下载（用于训练）

如果你需要训练自己的模型，需要下载训练数据集。**注意：仅用于推理的用户可以跳过此部分。**

### 前置要求

```bash
# 1. 安装训练依赖
apt-get install git git-annex jq -y

# 或者使用conda安装git-annex
conda install -c conda-forge git-annex -y
```

### 设置环境变量

```bash
# 设置TotalSpineSeg路径（如果从源码安装）
export TOTALSPINESEG="/root/TotalSpineSeg"

# 设置数据目录
export TOTALSPINESEG_DATA="/root/TotalSpineSeg/data"

# 永久设置（可选）
echo 'export TOTALSPINESEG="/root/TotalSpineSeg"' >> ~/.bashrc
echo 'export TOTALSPINESEG_DATA="/root/TotalSpineSeg/data"' >> ~/.bashrc
source ~/.bashrc
```

### 下载训练数据集

#### 步骤1：下载主要数据集

```bash
# 使用脚本自动下载所有训练数据集
bash /root/TotalSpineSeg/scripts/download_datasets.sh
```

**说明**:
- 脚本会从以下仓库下载数据集：
  - `git@data.neuro.polymtl.ca:datasets/whole-spine.git` (需要访问权限)
  - `git@data.neuro.polymtl.ca:datasets/spider-challenge-2023.git` (需要访问权限)
  - `git@github.com:spine-generic/data-multi-subject.git` (公开)
  - `git@github.com:spine-generic/data-single-subject.git` (公开)
- 数据集将下载到 `/root/TotalSpineSeg/data/bids/` 目录
- 某些数据集需要SSH访问权限，确保已配置SSH密钥

#### 步骤2：下载标签文件

```bash
# 下载标签文件（临时步骤，直到所有标签都推送到仓库）
cd /root/TotalSpineSeg/data
curl -L -O https://github.com/neuropoly/totalspineseg/releases/download/labels/labels_iso_bids_0924.zip
unzip -qo labels_iso_bids_0924.zip -d /root/TotalSpineSeg/data
rm labels_iso_bids_0924.zip
```

#### 步骤3：准备数据集（转换为nnUNet格式）

```bash
# 准备所有数据集（101和102，默认）
bash /root/TotalSpineSeg/scripts/prepare_datasets.sh

# 准备特定数据集
bash /root/TotalSpineSeg/scripts/prepare_datasets.sh 101  # 只准备101
bash /root/TotalSpineSeg/scripts/prepare_datasets.sh 102  # 只准备102
bash /root/TotalSpineSeg/scripts/prepare_datasets.sh 103  # 只准备103
bash /root/TotalSpineSeg/scripts/prepare_datasets.sh all  # 准备所有（101, 102, 103）

# 不使用数据增强（节省空间和时间）
bash /root/TotalSpineSeg/scripts/prepare_datasets.sh -noaug
bash /root/TotalSpineSeg/scripts/prepare_datasets.sh 101 -noaug
```

**说明**:
- 数据集将被转换为nnUNet格式，存储在 `/root/TotalSpineSeg/data/nnUNet/raw/` 目录
- 准备过程可能需要较长时间，取决于数据集大小
- 使用 `-noaug` 参数可以跳过数据增强，节省空间和时间

### 数据集说明

#### 主要训练数据集

1. **whole-spine**: OpenNeuro数据集
   - 访问：需要内部访问权限
   - 仓库：`git@data.neuro.polymtl.ca:datasets/whole-spine.git`

2. **SPIDER**: SPIDER挑战项目数据集
   - 访问：需要内部访问权限
   - 仓库：`git@data.neuro.polymtl.ca:datasets/spider-challenge-2023.git`
   - 包含手动标注的标签

3. **Spine Generic Project**: 单主体和多主体数据集
   - 访问：公开
   - 仓库：
     - `git@github.com:spine-generic/data-single-subject.git`
     - `git@github.com:spine-generic/data-multi-subject.git`

#### 辅助数据集（用于骶骨分割）

- GoldAtlas
- SynthRAD2023
- MRSpineSeg

### 验证数据集下载

```bash
# 检查BIDS数据集
ls -lh /root/TotalSpineSeg/data/bids/

# 检查nnUNet格式数据集
ls -lh /root/TotalSpineSeg/data/nnUNet/raw/

# 检查数据集大小
du -sh /root/TotalSpineSeg/data/bids/*
du -sh /root/TotalSpineSeg/data/nnUNet/raw/*
```

### 注意事项

1. **访问权限**: 某些数据集需要SSH访问权限，确保：
   - 已配置SSH密钥
   - 有访问 `data.neuro.polymtl.ca` 的权限

2. **磁盘空间**: 
   - 完整数据集（含数据增强）需要约3.5TB空间
   - 不使用数据增强可以减少空间需求

3. **下载时间**: 数据集下载可能需要较长时间，取决于网络速度

4. **git-annex**: 某些数据集使用git-annex存储大文件，确保已安装git-annex

---

## 基本推理使用

### 场景1：处理单个NIfTI文件

```bash
# 基本用法
totalspineseg input.nii.gz output_folder

# 处理未压缩的.nii文件
totalspineseg input.nii output_folder

# 使用各向同性输出（1mm分辨率，不重采样回原始空间）
totalspineseg input.nii.gz output_folder --iso
```

### 场景2：处理文件夹中的多个图像

```bash
# 处理文件夹中的所有.nii.gz和.nii文件
totalspineseg input_folder output_folder

# 指定图像后缀（例如只处理_T2w图像）
totalspineseg input_folder output_folder --suffix _T2w

# 处理多个后缀
totalspineseg input_folder output_folder --suffix _T1w _T2w
```

### 场景3：仅运行Step 1

```bash
# 只运行第一步模型（快速预览，不进行完整分割）
totalspineseg input_folder output_folder --step1
```

**使用场景**:
- 快速检查模型是否能识别脊柱结构
- 只需要粗分割结果
- 测试输入图像是否合适

---

## 高级选项

### 设备选择

```bash
# 使用GPU（默认，如果可用）
totalspineseg input_folder output_folder --device cuda

# 强制使用CPU
totalspineseg input_folder output_folder --device cpu
```

### 并行处理

```bash
# 指定最大并行工作进程数（默认：CPU核心数）
totalspineseg input_folder output_folder --max-workers 8

# 指定nnUNet的并行进程数（默认：min(CPU核心数, 内存GB/8)）
totalspineseg input_folder output_folder --max-workers-nnunet 4
```

### 输出控制

```bash
# 只保留特定输出文件夹（节省空间）
totalspineseg input_folder output_folder --keep-only step2_output preview

# 可用的输出文件夹：
# - step1_output: Step 1的标记结果
# - step1_cord: 脊髓软分割
# - step1_canal: 椎管软分割
# - step1_levels: 椎间盘水平位置
# - step2_output: 最终输出（推荐保留）
# - preview: 预览图像
```

### 静默模式

```bash
# 不显示进度条和详细信息
totalspineseg input_folder output_folder --quiet
```

### 多进程问题处理

```bash
# 如果遇到死锁问题，使用forkserver模式
totalspineseg input_folder output_folder --no-stalling
```

### 指定数据目录

```bash
# 如果模型权重不在默认位置
totalspineseg input_folder output_folder --data-dir /root/TotalSpineSeg/data
```

### 完整参数示例

```bash
totalspineseg \
    input_folder \
    output_folder \
    --iso \
    --device cuda \
    --max-workers 8 \
    --max-workers-nnunet 4 \
    --keep-only step2_output preview \
    --quiet
```

---

## 使用定位器辅助

定位器（localizer）图像可以帮助提高标记精度，特别是当主图像视野受限时（例如看不到C1或骶骨）。

### 步骤1：准备文件结构

```
project/
├── images/              # 主图像文件夹
│   ├── sub-01_T2w.nii.gz
│   └── sub-02_T2w.nii.gz
└── localizers/          # 定位器图像文件夹
    ├── sub-01_T1w.nii.gz
    └── sub-02_T1w.nii.gz
```

### 步骤2：处理定位器图像

```bash
# 处理定位器图像（推荐使用--iso确保分辨率一致）
totalspineseg localizers localizers_output --iso
```

### 步骤3：使用定位器结果处理主图像

```bash
# 基本用法（文件名相同）
totalspineseg images output --loc localizers_output/step2_output

# 指定后缀（文件名不同）
totalspineseg images output \
    --loc localizers_output/step2_output \
    --suffix _T2w \
    --loc-suffix _T1w

# 处理多个后缀
totalspineseg images output \
    --loc localizers_output/step2_output \
    --suffix _T1w _T2w \
    --loc-suffix _T1w_loc
```

### 步骤4：使用单个定位器文件

```bash
# 如果只有一个定位器文件
totalspineseg images output --loc localizers_output/step2_output/localizer.nii.gz
```

**重要提示**:
- 定位器和主图像必须对齐（同一坐标系）
- 定位器应该包含完整的脊柱视野（能看到C1和骶骨）
- 推荐对定位器使用`--iso`参数以确保分辨率一致

---

## 输出结果说明

### 输出文件夹结构

```
output_folder/
├── input/                   # 预处理后的输入图像（1mm各向同性，LPI方向）
├── preview/                 # 预览图像（JPEG格式）
│   ├── image_input.jpg      # 输入图像预览
│   ├── image_step1_raw.jpg  # Step 1原始输出预览
│   ├── image_step1_output.jpg      # Step 1标记结果预览
│   ├── image_step1_output_tags.jpg # Step 1带标签预览
│   ├── image_step2_raw.jpg  # Step 2原始输出预览
│   ├── image_step2_output.jpg      # 最终输出预览
│   └── image_step2_output_tags.jpg # 最终输出带标签预览
├── step1_raw/               # Step 1模型原始输出（概率图）
├── step1_output/            # Step 1迭代标记结果（NIfTI格式）
├── step1_cord/              # 脊髓软分割（概率图）
├── step1_canal/             # 椎管软分割（概率图）
├── step1_levels/            # 椎间盘水平位置（单个体素标记）
├── step2_raw/               # Step 2模型原始输出（概率图）
└── step2_output/            # 最终输出（完整标记的椎骨、椎间盘、脊髓、椎管）
```

### 关键输出文件

#### 1. step2_output/（最终输出，最重要）

包含完整标记的分割结果：
- **格式**: NIfTI (`.nii.gz`)
- **标签**: 见下方标签列表
- **空间**: 默认重采样回原始图像空间（除非使用`--iso`）

#### 2. step1_levels/（椎间盘水平位置）

- **格式**: NIfTI (`.nii.gz`)
- **内容**: 每个椎间盘水平在椎管中心线上的单个体素标记
- **编号**: 从C1开始（1=在C1上方，2=在C2上方，...）

#### 3. preview/（预览图像）

- **格式**: JPEG
- **用途**: 快速查看分割结果
- **带标签版本**: 显示椎骨和椎间盘的名称

### 标签映射

最终输出（step2_output）中的标签值：

| 标签值 | 结构名称 | 说明 |
|:------|:--------|:-----|
| 0 | background | 背景 |
| 1 | spinal_cord | 脊髓 |
| 2 | spinal_canal | 椎管 |
| 11 | vertebrae_C1 | 第1颈椎 |
| 12-17 | vertebrae_C2-C7 | 第2-7颈椎 |
| 21-32 | vertebrae_T1-T12 | 第1-12胸椎 |
| 41-45 | vertebrae_L1-L5 | 第1-5腰椎 |
| 50 | sacrum | 骶骨 |
| 63-67 | disc_C2-C3 到 C6-C7 | 颈椎间盘 |
| 71-82 | disc_C7-T1 到 T11-T12 | 颈胸和胸椎间盘 |
| 91-95 | disc_T12-L1 到 L4-L5 | 胸腰和腰椎间盘 |
| 100 | disc_L5-S | 腰骶椎间盘 |

**标签映射文件位置**: `totalspineseg/resources/labels_maps/tss_map.json`

---

## 常见使用场景

### 场景1：快速测试单个图像

```bash
# 1. 准备输入
mkdir -p /root/TotalSpineSeg/data/test_input
cp your_image.nii.gz /root/TotalSpineSeg/data/test_input/

# 2. 运行推理
totalspineseg /root/TotalSpineSeg/data/test_input /root/TotalSpineSeg/data/test_output

# 3. 查看结果
ls /root/TotalSpineSeg/data/test_output/step2_output/
ls /root/TotalSpineSeg/data/test_output/preview/
```

### 场景2：批量处理多个患者

```bash
# 假设你有以下结构：
# data/
#   ├── patient1/
#   │   └── T2w.nii.gz
#   ├── patient2/
#   │   └── T2w.nii.gz
#   └── patient3/
#       └── T2w.nii.gz

# 方法1：处理整个文件夹
totalspineseg data results

# 方法2：逐个处理（如果需要不同的参数）
for patient in data/patient*; do
    totalspineseg "$patient" "results/$(basename $patient)"
done
```

### 场景3：处理BIDS格式数据

```bash
# BIDS结构示例：
# bids/
#   ├── sub-01/
#   │   └── anat/
#   │       └── sub-01_T2w.nii.gz
#   └── sub-02/
#       └── anat/
#           └── sub-02_T2w.nii.gz

# 处理所有T2w图像
totalspineseg bids results --suffix _T2w

# 输出将保持BIDS结构
```

### 场景4：只获取最终结果（节省空间）

```bash
# 只保留最终输出和预览
totalspineseg input_folder output_folder \
    --keep-only step2_output preview
```

### 场景5：使用各向同性输出（用于可视化）

```bash
# 输出保持1mm各向同性分辨率（不重采样）
totalspineseg input_folder output_folder --iso
```

### 场景6：CPU推理（无GPU环境）

```bash
# 强制使用CPU
totalspineseg input_folder output_folder --device cpu

# 注意：CPU推理会非常慢，建议使用GPU
```

---

## 故障排除

### 问题1：模型未找到

**错误信息**: `FileNotFoundError: Model weights are missing.`

**解决方案**:
```bash
# 手动初始化模型
totalspineseg_init

# 或指定数据目录
totalspineseg_init --data-dir /root/TotalSpineSeg/data
```

### 问题2：CUDA内存不足

**错误信息**: `RuntimeError: CUDA out of memory`

**解决方案**:
```bash
# 减少并行进程数
totalspineseg input_folder output_folder --max-workers-nnunet 2

# 或使用CPU（虽然慢，但不会内存溢出）
totalspineseg input_folder output_folder --device cpu
```

### 问题3：多进程死锁

**错误信息**: 程序卡住不动

**解决方案**:
```bash
# 使用forkserver模式
totalspineseg input_folder output_folder --no-stalling

# 或减少并行进程数
totalspineseg input_folder output_folder --max-workers 2
```

### 问题4：输入文件格式不支持

**错误信息**: `Unknown file type`

**解决方案**:
- 确保输入文件是`.nii.gz`或`.nii`格式
- 使用`nibabel`或其他工具转换格式

### 问题5：定位器匹配失败

**错误信息**: 定位器无法匹配主图像

**解决方案**:
- 确保定位器和主图像在同一坐标系
- 检查文件名是否匹配（或正确使用`--suffix`和`--loc-suffix`）
- 确保定位器包含完整的脊柱视野

### 问题6：输出空间不匹配

**问题**: 输出结果的空间信息与输入不一致

**解决方案**:
```bash
# 使用--iso参数保持模型原始分辨率
totalspineseg input_folder output_folder --iso

# 或者检查输入图像的头部信息是否正确
```

### 问题7：查看详细错误信息

```bash
# 不使用--quiet参数，查看完整输出
totalspineseg input_folder output_folder

# 检查Python环境
python -c "import totalspineseg; print('OK')"

# 检查nnU-Net
python -c "import nnunetv2; print('OK')"
```

---

## 性能优化建议

### 1. GPU设置

```bash
# 确保使用GPU
totalspineseg input_folder output_folder --device cuda

# 检查GPU使用情况
watch -n 1 nvidia-smi
```

### 2. 并行处理

```bash
# 根据系统资源调整并行数
# 内存充足：--max-workers-nnunet 4-8
# 内存有限：--max-workers-nnunet 2-4
totalspineseg input_folder output_folder --max-workers-nnunet 4
```

### 3. 批量处理

```bash
# 对于大量图像，考虑分批处理
# 避免一次性处理太多文件导致内存溢出
```

### 4. 存储优化

```bash
# 只保留需要的输出
totalspineseg input_folder output_folder --keep-only step2_output
```

---

## 验证结果

### 检查输出文件

```bash
# 查看输出文件列表
ls -lh output_folder/step2_output/

# 检查文件大小（应该不为0）
du -sh output_folder/step2_output/*

# 使用nibabel检查文件
python -c "import nibabel as nib; img = nib.load('output_folder/step2_output/image.nii.gz'); print(f'Shape: {img.shape}'); print(f'Labels: {set(img.get_fdata().flatten())}')"
```

### 查看预览图像

```bash
# 在文件管理器中打开预览文件夹
# 或使用图像查看器
xdg-open output_folder/preview/  # Linux
open output_folder/preview/      # macOS
```

---

## 完整工作流程示例

### 示例：处理一个完整的患者数据集

```bash
# 1. 激活环境
conda activate tss

# 2. 准备数据目录
mkdir -p /root/TotalSpineSeg/data/{input,output}

# 3. 复制输入图像
cp patient_data/*.nii.gz /root/TotalSpineSeg/data/input/

# 4. 运行推理
totalspineseg \
    /root/TotalSpineSeg/data/input \
    /root/TotalSpineSeg/data/output \
    --device cuda \
    --max-workers 8 \
    --keep-only step2_output preview

# 5. 检查结果
ls /root/TotalSpineSeg/data/output/step2_output/
ls /root/TotalSpineSeg/data/output/preview/

# 6. 查看预览（可选）
xdg-open /root/TotalSpineSeg/data/output/preview/
```

---

## 获取帮助

### 查看命令帮助

```bash
# 查看主命令帮助
totalspineseg --help

# 查看初始化命令帮助
totalspineseg_init --help
```

### 查看所有可用工具

TotalSpineSeg还提供了其他工具命令：

```bash
# 查看所有可用命令
totalspineseg_<TAB><TAB>  # 在bash中按Tab键自动补全

# 可用的工具命令包括：
# - totalspineseg_cpdir
# - totalspineseg_fill_canal
# - totalspineseg_iterative_label
# - totalspineseg_largest_component
# - totalspineseg_resample
# - totalspineseg_preview_jpg
# - totalspineseg_map_labels
# - totalspineseg_transform_seg2image
# - totalspineseg_reorient_canonical
# - totalspineseg_average4d
# - totalspineseg_crop_image2seg
# - totalspineseg_extract_soft
# - totalspineseg_extract_levels
# - totalspineseg_extract_alternate
# - totalspineseg_install_weights
# - totalspineseg_predict_nnunet
```

---

## 注意事项

1. **首次运行**: 首次运行会自动下载预训练模型（几GB），需要网络连接
2. **GPU推荐**: 强烈推荐使用GPU，CPU推理会非常慢
3. **内存需求**: 处理大图像需要足够的内存（建议16GB+）
4. **磁盘空间**: 输出文件可能较大，确保有足够空间
5. **输入格式**: 只支持NIfTI格式（`.nii.gz`或`.nii`）
6. **图像对齐**: 使用定位器时，确保定位器和主图像对齐
7. **脊髓分割**: TotalSpineSeg的脊髓分割不适用于CSA分析，请使用SCT工具

---

## 快速参考

### 最常用命令

```bash
# 基本推理
totalspineseg input_folder output_folder

# 使用GPU和各向同性输出
totalspineseg input_folder output_folder --iso --device cuda

# 只保留最终结果
totalspineseg input_folder output_folder --keep-only step2_output

# 使用定位器
totalspineseg images output --loc localizers_output/step2_output
```

### 环境变量

```bash
# 设置模型数据目录
export TOTALSPINESEG_DATA="/root/TotalSpineSeg/data"
```

---

*本文档基于TotalSpineSeg项目代码和README自动生成，最后更新：2025年*

