# TotalSpineSeg 项目说明

## 项目概述

**TotalSpineSeg** 是一个用于MRI图像中自动实例分割和标记的工具，能够自动识别和分割所有椎骨（vertebrae）、椎间盘（intervertebral discs, IVDs）、脊髓（spinal cord）和椎管（spinal canal）。该工具对各种MRI对比度、采集方向和分辨率具有鲁棒性。

- **项目版本**: 20251028
- **开发状态**: Production/Stable（生产/稳定版）
- **主要作者**: Yehuda Warszawer, Nathan Molinier, Anat Achiron, Julien Cohen-Adad
- **DOI**: [10.5281/zenodo.13894354](https://doi.org/10.5281/zenodo.13894354)

## 核心功能

### 1. 自动分割功能
- **椎骨分割**: 自动识别和分割C1-C7（颈椎）、T1-T12（胸椎）、L1-L5（腰椎）以及骶骨（sacrum）
- **椎间盘分割**: 自动识别和分割所有椎间盘（C2-C3到L5-S）
- **脊髓分割**: 自动分割脊髓结构
- **椎管分割**: 自动分割椎管结构

### 2. 智能标记系统
- 使用迭代算法对每个椎骨和椎间盘进行精确标记
- 支持基于定位器（localizer）的标记，适用于视野受限的图像
- 自动识别关键解剖标志点（C1、C2-C3、C7-T1、T12-L1、L5-S等）

## 技术架构

### 模型架构
项目采用**混合方法**，结合了nnU-Net深度学习模型和迭代算法：

#### 第一步（Step 1 - Dataset101）
- **输入**: MRI图像
- **输出**: 9个类别
  - 4个语义类别：脊髓、椎管、椎间盘、椎骨
  - 5个标志类别：C2-C3、C7-T1、T12-L1、L5-S椎间盘，以及C1椎骨
- **处理**: 使用迭代算法映射单个椎间盘，提取奇数椎间盘分割

#### 第二步（Step 2 - Dataset102）
- **输入**: 
  - 通道1：MRI图像
  - 通道2：从第一步提取的奇数椎间盘
- **输出**: 10个类别
  - 5个语义类别：脊髓、椎管、椎间盘、奇数椎骨、偶数椎骨
  - 5个标志类别：C2-C3、C7-T1、T12-L1、L5-S椎间盘，以及骶骨
- **处理**: 使用算法为每个椎骨和椎间盘分配独立标签，生成最终分割结果

### 技术栈
- **深度学习框架**: nnU-Net v2（基于PyTorch）
- **编程语言**: Python >= 3.10
- **主要依赖库**:
  - `nibabel`: NIfTI图像处理
  - `SimpleITK`: 医学图像处理
  - `nilearn`: 神经影像分析
  - `scipy`: 科学计算
  - `torchio`: 医学图像变换
  - `gryds`: 图像配准

## 项目结构

```
TotalSpineSeg/
├── totalspineseg/          # 主程序包
│   ├── __init__.py        # 包初始化
│   ├── inference.py       # 推理主程序
│   ├── init_inference.py  # 模型初始化
│   ├── models/            # 模型权重存储
│   ├── resources/         # 资源文件
│   │   ├── datasets/      # 数据集配置
│   │   └── labels_maps/   # 标签映射配置
│   └── utils/             # 工具函数
│       ├── augment.py     # 数据增强
│       ├── extract_*.py   # 提取功能
│       ├── iterative_label.py  # 迭代标记算法
│       ├── predict_nnunet.py   # nnU-Net预测
│       ├── resample.py    # 重采样
│       └── ...            # 其他工具
├── scripts/               # 训练脚本
│   ├── download_datasets.sh    # 下载数据集
│   ├── prepare_datasets.sh     # 准备数据集
│   └── train.sh                 # 训练模型
├── pyproject.toml         # 项目配置
├── README.md              # 英文说明文档
└── LICENSE                # 许可证
```

## 主要模块说明

### 1. 推理模块 (`inference.py`)
- **功能**: 执行模型推理的主入口
- **主要流程**:
  1. 图像预处理（重采样、重定向、归一化）
  2. 运行Step 1模型
  3. 提取奇数椎间盘
  4. 运行Step 2模型
  5. 后处理（迭代标记、填充椎管等）
  6. 结果转换回原始图像空间

### 2. 工具模块 (`utils/`)
- **iterative_label.py**: 迭代标记算法，用于为椎骨和椎间盘分配精确标签
- **extract_alternate.py**: 提取奇数/偶数椎间盘
- **extract_levels.py**: 提取椎间盘水平位置
- **extract_soft.py**: 提取软分割（概率图）
- **fill_canal.py**: 填充椎管标签
- **largest_component.py**: 提取最大连通分量
- **resample.py**: 图像重采样
- **transform_seg2image.py**: 将分割结果转换回原始图像空间
- **preview_jpg.py**: 生成预览图像

### 3. 资源文件 (`resources/`)
- **labels_maps/**: 标签映射配置文件
  - `tss_map.json`: 完整的标签映射（椎骨、椎间盘、脊髓、椎管）
  - `nnunet_step1.json`: Step 1模型标签映射
  - `nnunet_step2.json`: Step 2模型标签映射
- **datasets/**: 数据集配置文件

## 标签系统

### 椎骨标签
- **颈椎**: C1(11), C2(12), C3(13), C4(14), C5(15), C6(16), C7(17)
- **胸椎**: T1(21), T2(22), ..., T12(32)
- **腰椎**: L1(41), L2(42), L3(43), L4(44), L5(45)
- **骶骨**: 50

### 椎间盘标签
- **颈椎间盘**: C2-C3(63), C3-C4(64), C4-C5(65), C5-C6(66), C6-C7(67)
- **颈胸连接**: C7-T1(71)
- **胸椎间盘**: T1-T2(72), ..., T11-T12(82)
- **胸腰连接**: T12-L1(91)
- **腰椎间盘**: L1-L2(92), L2-L3(93), L3-L4(94), L4-L5(95)
- **腰骶连接**: L5-S(100)

### 其他结构
- **脊髓**: 1
- **椎管**: 2

## 使用方法

### 安装
```bash
# 创建虚拟环境
python3 -m venv venv
source venv/bin/activate

# 安装包
pip install totalspineseg[nnunetv2]

# 安装PyTorch（GPU支持）
pip install torch==2.5.1 torchvision==0.20.1 torchaudio==2.5.1 --index-url https://download.pytorch.org/whl/cu118
```

### 基本推理
```bash
# 处理单个文件
totalspineseg input.nii.gz output_folder

# 处理文件夹
totalspineseg input_folder output_folder

# 仅运行Step 1
totalspineseg input_folder output_folder --step1

# 使用各向同性输出（1mm分辨率）
totalspineseg input_folder output_folder --iso
```

### 使用定位器辅助标记
```bash
# 1. 先处理定位器图像
totalspineseg localizers localizers_output --iso

# 2. 使用定位器结果处理主图像
totalspineseg images output --loc localizers_output/step2_output --suffix _T2w --loc-suffix _T1w
```

## 输出结构

推理完成后，输出文件夹包含以下内容：

```
output_folder/
├── input/              # 预处理后的输入图像
├── preview/            # 预览图像（JPEG格式）
├── step1_raw/          # Step 1模型原始输出
├── step1_output/       # Step 1迭代标记结果
├── step1_cord/         # 脊髓软分割
├── step1_canal/        # 椎管软分割
├── step1_levels/       # 椎间盘水平位置（单个体素标记）
├── step2_raw/          # Step 2模型原始输出
└── step2_output/       # Step 2最终输出（最终分割结果）
```

## 训练要求

### 硬件要求
- **磁盘空间**: 约3.5TB（包含数据增强）
- **内存**: 至少32GB RAM
- **GPU**: CUDA GPU，至少8GB VRAM

### 训练流程
1. 下载数据集到 `$TOTALSPINESEG_DATA/bids`
2. 准备nnUNet格式数据集：`bash scripts/prepare_datasets.sh`
3. 训练模型：`bash scripts/train.sh [DATASET_ID] [FOLD]`

### 训练日志解读

#### Pseudo Dice 值对应类别（Dataset101 - Step 1）

训练日志中的 `Pseudo dice` 值对应9个输出类别（按顺序）：

| 索引 | 类别ID | 类别名称 | 说明 |
|:----:|:------:|:--------|:-----|
| 0 | 1 | `disc` (general) | 通用椎间盘（未标记的） |
| 1 | 2 | `disc_C2_C3` | C2-C3椎间盘（关键标志点） |
| 2 | 3 | `disc_C7_T1` | C7-T1椎间盘（关键标志点） |
| 3 | 4 | `disc_T12_L1` | T12-L1椎间盘（关键标志点） |
| 4 | 5 | `disc_L5_S` | L5-S椎间盘（关键标志点） |
| 5 | 6 | `vertebrae` (general) | 通用椎骨（未标记的） |
| 6 | 7 | `vertebrae_C1` | C1椎骨（关键标志点） |
| 7 | 8 | `canal` | 椎管 |
| 8 | 9 | `cord` | 脊髓 |

**说明**：
- **nan 值**：表示该类别在当前batch中不存在（真值和预测都没有），无法计算Dice系数
- **0.0 值**：表示该类别存在但预测完全错误（Dice=0）
- **非零值**：表示该类别的分割准确度，值越高越好（范围0-1）

**示例**：`Pseudo dice [0.0, 0.0, 0.0, nan, nan, 0.2953, 0.0, 0.3622, 0.0]`
- 通用椎间盘、C2-C3、C7-T1椎间盘：0.0（预测错误）
- T12-L1、L5-S椎间盘：nan（当前batch中不存在）
- 通用椎骨：0.2953（部分准确）
- C1椎骨：0.0（预测错误）
- 椎管：0.3622（相对最好）
- 脊髓：0.0（预测错误）

## 数据集

模型在以下数据集上训练：
- **whole-spine**: OpenNeuro数据集
- **SPIDER**: SPIDER挑战项目数据集
- **Spine Generic Project**: 单主体和多主体数据集

## 应用场景

1. **临床研究**: 脊柱疾病的自动分析和量化
2. **影像分析**: MRI图像的自动分割和标记
3. **手术规划**: 为脊柱手术提供精确的解剖结构信息
4. **纵向研究**: 跟踪脊柱结构随时间的变化

## 重要说明

⚠️ **关于脊髓分割**: 虽然TotalSpineSeg提供脊髓分割功能，但**不建议**将其用于横截面积（CSA）分析。该工具的脊髓分割未经验证用于CSA测量，也未在涉及脊髓压迫、MS病变或其他脊髓异常的情况下进行测试。对于准确的CSA分析，强烈建议使用[Spinal Cord Toolbox](https://spinalcordtoolbox.com/)中经过验证的算法。

## 引用

如果使用本项目，请引用：

```bibtex
@article{warszawer2025totalspineseg,
   title={TotalSpineSeg: Robust Spine Segmentation with Landmark-Based Labeling in MRI},
   author={Warszawer, Yehuda and Molinier, Nathan and Valosek, Jan and Benveniste, Pierre-Louis and Bédard, Sandrine and Shirbint, Emanuel and Mohamed, Feroze and Tsagkas, Charidimos and Kolind, Shannon and Lynd, Larry and Oh, Jiwon and Prat, Alexandre and Tam, Roger and Traboulsee, Anthony and Patten, Scott and Lee, Lisa Eunyoung and Achiron, Anat and Cohen-Adad, Julien},
   year={2025},
   journal={ResearchGate preprint},
   url={https://www.researchgate.net/publication/389881289_TotalSpineSeg_Robust_Spine_Segmentation_with_Landmark-Based_Labeling_in_MRI}
}
```

同时请引用nnU-Net：
```bibtex
@article{isensee2021nnunet,
  title={nnU-Net: a self-configuring method for deep learning-based biomedical image segmentation},
  author={Isensee, Fabian and Jaeger, Paul F and Kohl, Simon AA and Petersen, Jens and Maier-Hein, Klaus H},
  journal={Nature methods},
  volume={18},
  number={2},
  pages={203--211},
  year={2021}
}
```

## 许可证

请查看项目根目录下的 `LICENSE` 文件。

## 相关链接

- **GitHub仓库**: https://github.com/neuropoly/totalspineseg
- **nnU-Net**: https://github.com/MIC-DKFZ/nnUNet
- **Spinal Cord Toolbox**: https://spinalcordtoolbox.com/
- **3D Slicer**: https://www.slicer.org/

---

*本文档基于项目代码和README自动生成，最后更新：2025年*

